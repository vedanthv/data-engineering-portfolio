version: "3.8"

volumes:
  rpdata:
  chdata:
  metabase_db:

services:

  redpanda:
    image: redpandadata/redpanda:v24.2.10
    command:
      - redpanda start
      - --overprovisioned
      - --smp=1
      - --memory=1G
      - --reserve-memory=0M
      - --node-id=0
      - --check=false
      - --kafka-addr=PLAINTEXT://0.0.0.0:9092
      - --advertise-kafka-addr=PLAINTEXT://redpanda:9092
      - --pandaproxy-addr=0.0.0.0:8082
      - --advertise-pandaproxy-addr=redpanda:8082
    ports:
      - "9092:9092"   # Kafka API (internal use; keep SG closed)
      - "9644:9644"   # Admin/metrics
      - "8082:8082"   # Pandaproxy
    volumes:
      - rpdata:/var/lib/redpanda
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "bash", "-c", "rpk cluster info --brokers=localhost:9092 || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 10

  redpanda-console:
    image: redpandadata/console:latest
    environment:
      KAFKA_BROKERS: redpanda:9092
    ports:
      - "8080:8080"  
    depends_on:
      - redpanda
    restart: unless-stopped

  clickhouse:
    image: clickhouse/clickhouse-server:24.8
    container_name: clickhouse
    environment:
      CLICKHOUSE_DB: coldchain
      CLICKHOUSE_USER: ch
      CLICKHOUSE_PASSWORD: chpwd
    ports:
      - "8123:8123"  
      - "9000:9000"  
    volumes:
      - chdata:/var/lib/clickhouse
    ulimits:
      nofile: 262144
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "bash", "-lc", "wget -qO- http://localhost:8123/?query=SELECT%201 | grep -q 1"]
      interval: 15s
      timeout: 5s
      retries: 20

  flink-jobmanager:
    image: flink:1.19-scala_2.12-java11
    command: jobmanager
    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: flink-jobmanager
        metrics.reporter.prom.class: org.apache.flink.metrics.prometheus.PrometheusReporter
        metrics.reporter.prom.port: 9250
    ports:
      - "8081:8081"   
    depends_on:
      - redpanda
    restart: unless-stopped

  flink-taskmanager:
    image: flink:1.19-scala_2.12-java11
    command: taskmanager
    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: flink-jobmanager
        taskmanager.numberOfTaskSlots: 2
    depends_on:
      - flink-jobmanager
    restart: unless-stopped

  metabase-postgres:
    image: postgres:15
    container_name: metabase-postgres
    environment:
      POSTGRES_DB: metabase
      POSTGRES_USER: metauser
      POSTGRES_PASSWORD: metapass
    volumes:
      - metabase_db:/var/lib/postgresql/data
    restart: unless-stopped

  metabase:
    image: metabase/metabase:latest
    container_name: metabase
    ports:
      - "3000:3000"  
    environment:
      MB_DB_TYPE: postgres
      MB_DB_DBNAME: metabase
      MB_DB_PORT: 5432
      MB_DB_USER: metauser
      MB_DB_PASS: metapass
      MB_DB_HOST: metabase-postgres
    depends_on:
      - metabase-postgres
    restart: unless-stopped
