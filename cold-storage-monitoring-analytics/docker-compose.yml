version: "3.8"

volumes:
  redpanda-data:
  chdata:
  metabase_db:

services:

  redpanda:
    image: redpandadata/redpanda:v23.3.10
    command:
      - redpanda start
      - --overprovisioned
      - --smp=1
      - --memory=1G
      - --reserve-memory=0M
      - --check=false
      - --node-id=0
      - --kafka-addr=internal://0.0.0.0:9092,external://0.0.0.0:19092
      - --advertise-kafka-addr=internal://redpanda:9092,external://localhost:19092
      - --rpc-addr=0.0.0.0:33145
      - --advertise-rpc-addr=redpanda:33145
      - --pandaproxy-addr=0.0.0.0:8082
      - --advertise-pandaproxy-addr=redpanda:8082
      - --schema-registry-addr=0.0.0.0:8081
    ports:
      - "9092:9092"
      - "19092:19092"
      - "8081:8081"
      - "8082:8082"
    volumes:
      - redpanda-data:/var/lib/redpanda/data

  redpanda-console:
    image: redpandadata/console:latest
    environment:
      KAFKA_BROKERS: redpanda:9092
    ports:
      - "8080:8080"
    depends_on:
      - redpanda

  clickhouse:
    image: clickhouse/clickhouse-server:24.8
    container_name: clickhouse
    environment:
      CLICKHOUSE_DB: coldchain
      CLICKHOUSE_USER: ch
      CLICKHOUSE_PASSWORD: chpwd
    ports:
      - "8123:8123"
      - "9000:9000"
    volumes:
      - chdata:/var/lib/clickhouse
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "bash", "-lc", "wget -qO- http://localhost:8123/?query=SELECT%201 | grep -q 1"]
      interval: 15s
      timeout: 5s
      retries: 20

  flink-jobmanager:
    image: flink:1.19-scala_2.12-java11
    command: jobmanager
    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: flink-jobmanager
        metrics.reporter.prom.class: org.apache.flink.metrics.prometheus.PrometheusReporter
        metrics.reporter.prom.port: 9250
    ports:
      - "8085:8085"
    depends_on:
      - redpanda

  flink-taskmanager:
    image: flink:1.19-scala_2.12-java11
    command: taskmanager
    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: flink-jobmanager
        taskmanager.numberOfTaskSlots: 2
    depends_on:
      - flink-jobmanager

  metabase:
    image: metabase/metabase:latest
    environment:
      MB_DB_FILE: /metabase.db/metabase.db
    ports:
      - "3000:3000"
    volumes:
      - metabase_db:/metabase.db
    depends_on:
      - clickhouse

  data-generator:
    image: python:3.11-slim
    container_name: data-generator
    working_dir: /app
    volumes:
      - ./data-generator.py:/app/data-generator.py:ro
    environment:
      BOOTSTRAP: "redpanda:9092"
      TEMP_TOPIC: "cc.temp_readings"
      DOOR_TOPIC: "cc.door_events"
      ASSET_COUNT: "50"
      SLEEP_SECS: "5"
      NUM_PARTITIONS: "6"
      REPLICATION_FACTOR: "1"
      DOOR_EVENT_PROB: "0.05"
      EXCURSION_PROB: "0.02"
      FREEZER_RATIO: "0.2"
    command: >
      sh -c "apt-get update && apt-get install -y --no-install-recommends librdkafka-dev gcc g++ &&
             pip install --no-cache-dir confluent-kafka &&
             python3 /app/data-generator.py"
    depends_on:
      - redpanda
    restart: unless-stopped
